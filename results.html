<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCI Study - Results</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        /* some extra styles for this page */
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a2e;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .winner {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .export-btns {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 10px 20px;
            background: #4a90d9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .export-btn:hover {
            background: #357abd;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .chart-placeholder {
            background: #f0f0f0;
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            margin: 20px 0;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 40px;
            height: 200px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 80px;
            background: #4a90d9;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }

        .bar.ui-a {
            background: #e63946;
        }

        .bar.ui-b {
            background: #28a745;
        }

        .bar-label {
            font-weight: 600;
            color: #333;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            text-align: center;
        }

        /* Donut Chart Styles */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 20px;
            text-align: center;
        }

        .donut-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .donut {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .donut-hole {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-total {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .donut-label {
            font-size: 11px;
            color: #666;
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .legend-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .legend-name {
            font-size: 13px;
            color: #333;
        }

        .legend-value {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 14px;
        }

        .legend-percent {
            font-size: 12px;
            color: #666;
            margin-left: 4px;
        }

        /* Demographics Section */
        .demographics-section {
            margin-bottom: 40px;
        }

        .section-header {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a90d9;
        }
    </style>
</head>
<body>
    <div class="results-container">
        <a href="index.html" class="back-btn">← Back to Home</a>

        <div class="results-header">
            <h1>Test Results</h1>
            <p>UI-A (Classic) vs UI-B (Focus Frame) comparison</p>
        </div>

        <!-- export buttons -->
        <div class="export-btns">
            <button class="export-btn" onclick="exportResultsAsJSON()">Download JSON</button>
            <button class="export-btn" onclick="exportResultsAsCSV()">Download CSV</button>
            <button class="clear-btn" onclick="handleClear()">Clear Data</button>
        </div>

        <!-- summary cards -->
        <div class="comparison-section" id="comparisonSection">
            <!-- will be filled by js -->
        </div>

        <!-- Demographics Charts -->
        <div class="demographics-section">
            <h2 class="section-header">Participant Demographics</h2>
            <div class="charts-section" id="demographicsCharts">
                <!-- Will be filled by JS -->
            </div>
        </div>

        <!-- Instructor Metrics Section -->
        <div class="demographics-section">
            <h2 class="section-header">Engagement Metrics (Instructor Requirements)</h2>
            <div class="charts-section" id="engagementCharts">
                <!-- Will be filled by JS -->
            </div>
        </div>

        <!-- visual comparison -->
        <div class="result-card">
            <h3>Reading Time Comparison</h3>
            <div class="bar-chart" id="timeChart">
                <div class="bar-wrapper">
                    <div class="bar ui-a" id="barA" style="height: 0px;"></div>
                    <span class="bar-label">UI-A</span>
                    <span id="timeA">-</span>
                </div>
                <div class="bar-wrapper">
                    <div class="bar ui-b" id="barB" style="height: 0px;"></div>
                    <span class="bar-label">UI-B</span>
                    <span id="timeB">-</span>
                </div>
            </div>
        </div>

        <!-- raw data table -->
        <div class="result-card">
            <h3>All Test Data</h3>
            <div id="dataTableContainer">
                <!-- table goes here -->
            </div>
        </div>
    </div>

    <script src="tracking.js"></script>
    <script>
        // global variable to store all results with their Firebase keys
        var allResults = [];
        var resultKeys = {}; // maps sessionId to Firebase key

        // load and display results when page opens
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
        });

        function loadResults() {
            // show loading message
            document.getElementById('dataTableContainer').innerHTML = '<p style="text-align:center;">Loading data...</p>';

            // try to load from Firebase first
            if (typeof firebase !== 'undefined' && firebaseReady && database) {
                database.ref('results').once('value')
                    .then(function(snapshot) {
                        var data = snapshot.val();
                        allResults = [];
                        resultKeys = {};

                        if (data) {
                            // convert object to array and store keys
                            Object.keys(data).forEach(function(key) {
                                var item = data[key];
                                item._firebaseKey = key; // store the key with the item
                                allResults.push(item);
                                if (item.sessionId) {
                                    resultKeys[item.sessionId] = key;
                                }
                            });
                        }

                        // sort by date (newest first)
                        allResults.sort(function(a, b) {
                            return new Date(b.completedAt) - new Date(a.completedAt);
                        });

                        displayAllData();
                    })
                    .catch(function(err) {
                        console.warn('Firebase read failed, using localStorage:', err);
                        allResults = getResults();
                        displayAllData();
                    });
            } else {
                // fallback to localStorage
                allResults = getResults();
                displayAllData();
            }
        }

        function displayAllData() {
            if (allResults.length === 0) {
                showNoData();
                return;
            }

            // calculate stats from allResults
            var stats = calculateStats(allResults);

            // display comparison cards
            displayComparison(stats);

            // display demographics charts
            displayDemographicsCharts(allResults);

            // display engagement metrics (instructor requirements)
            displayEngagementCharts(allResults);

            // display chart
            displayChart(stats);

            // display table
            displayTable(allResults);
        }

        // Color palettes for charts
        var chartColors = {
            gender: ['#4a90d9', '#e63946', '#28a745', '#ffc107'],
            age: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'],
            occupation: ['#28a745', '#ffc107', '#17a2b8', '#6f42c1'],
            ui: ['#e63946', '#28a745'],
            comprehension: ['#28a745', '#dc3545']  // green for correct, red for incorrect
        };

        // Create conic gradient for donut chart
        function createConicGradient(data, colors) {
            var total = data.reduce(function(sum, item) { return sum + item.value; }, 0);
            if (total === 0) return 'conic-gradient(#e0e0e0 0deg 360deg)';

            var gradientParts = [];
            var currentAngle = 0;

            data.forEach(function(item, index) {
                var percent = (item.value / total) * 100;
                var angle = (item.value / total) * 360;
                var color = colors[index % colors.length];

                gradientParts.push(color + ' ' + currentAngle + 'deg ' + (currentAngle + angle) + 'deg');
                currentAngle += angle;
            });

            return 'conic-gradient(' + gradientParts.join(', ') + ')';
        }

        // Create a single chart card
        function createChartCard(title, data, colors, totalLabel) {
            var total = data.reduce(function(sum, item) { return sum + item.value; }, 0);

            var legendHtml = data.map(function(item, index) {
                var percent = total > 0 ? Math.round((item.value / total) * 100) : 0;
                return `
                    <div class="legend-item">
                        <div class="legend-left">
                            <div class="legend-color" style="background: ${colors[index % colors.length]}"></div>
                            <span class="legend-name">${item.name}</span>
                        </div>
                        <div>
                            <span class="legend-value">${item.value}</span>
                            <span class="legend-percent">(${percent}%)</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-card">
                    <h3 class="chart-title">${title}</h3>
                    <div class="donut-container">
                        <div class="donut" style="background: ${createConicGradient(data, colors)}">
                            <div class="donut-hole">
                                <span class="donut-total">${total}</span>
                                <span class="donut-label">${totalLabel}</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-legend">
                        ${legendHtml}
                    </div>
                </div>
            `;
        }

        // Count occurrences and create data array
        function countByField(results, field, labelMap) {
            var counts = {};
            results.forEach(function(r) {
                var value = r[field] || 'Unknown';
                counts[value] = (counts[value] || 0) + 1;
            });

            return Object.keys(counts).map(function(key) {
                return {
                    name: labelMap && labelMap[key] ? labelMap[key] : key,
                    value: counts[key]
                };
            }).sort(function(a, b) { return b.value - a.value; });
        }

        // Get unique participants for demographics
        function getUniqueParticipants(results) {
            var seen = {};
            return results.filter(function(r) {
                if (seen[r.participantId]) return false;
                seen[r.participantId] = true;
                return true;
            });
        }

        // Display all demographics charts
        function displayDemographicsCharts(results) {
            var uniqueParticipants = getUniqueParticipants(results);
            var container = document.getElementById('demographicsCharts');

            if (uniqueParticipants.length === 0) {
                container.innerHTML = '<p class="no-data">No demographic data available</p>';
                return;
            }

            var html = '';

            // Gender chart
            var genderLabels = {
                'male': 'Male',
                'female': 'Female',
                'other': 'Other',
                'prefer-not-to-say': 'Prefer not to say',
                'unknown': 'Unknown'
            };
            var genderData = countByField(uniqueParticipants, 'gender', genderLabels);
            html += createChartCard('Gender Distribution', genderData, chartColors.gender, 'Participants');

            // Age Group chart
            var ageLabels = {
                '18-24': '18-24',
                '25-34': '25-34',
                '35-44': '35-44',
                '45-54': '45-54',
                '55+': '55+',
                'unknown': 'Unknown'
            };
            var ageData = countByField(uniqueParticipants, 'ageGroup', ageLabels);
            html += createChartCard('Age Distribution', ageData, chartColors.age, 'Participants');

            // Occupation chart
            var occupationLabels = {
                'student': 'Student',
                'working': 'Working',
                'other': 'Other',
                'unknown': 'Unknown'
            };
            var occupationData = countByField(uniqueParticipants, 'occupation', occupationLabels);
            html += createChartCard('Occupation', occupationData, chartColors.occupation, 'Participants');

            // UI Version distribution (all results, not unique participants)
            var uiData = countByField(results, 'uiVersion', { 'A': 'UI-A (Classic)', 'B': 'UI-B (Focus)' });
            html += createChartCard('Test Distribution', uiData, chartColors.ui, 'Sessions');

            // Comprehension Score by UI Version
            var uiAResults = results.filter(function(r) { return r.uiVersion === 'A'; });
            var uiBResults = results.filter(function(r) { return r.uiVersion === 'B'; });

            // UI-A Comprehension
            var uiACorrect = uiAResults.filter(function(r) { return r.comprehensionScore === 1; }).length;
            var uiAIncorrect = uiAResults.filter(function(r) { return r.comprehensionScore === 0; }).length;
            var uiACompData = [
                { name: 'Correct', value: uiACorrect },
                { name: 'Incorrect', value: uiAIncorrect }
            ];
            html += createChartCard('UI-A Comprehension', uiACompData, chartColors.comprehension, 'Answers');

            // UI-B Comprehension
            var uiBCorrect = uiBResults.filter(function(r) { return r.comprehensionScore === 1; }).length;
            var uiBIncorrect = uiBResults.filter(function(r) { return r.comprehensionScore === 0; }).length;
            var uiBCompData = [
                { name: 'Correct', value: uiBCorrect },
                { name: 'Incorrect', value: uiBIncorrect }
            ];
            html += createChartCard('UI-B Comprehension', uiBCompData, chartColors.comprehension, 'Answers');

            container.innerHTML = html;
        }

        // Display engagement metrics charts (instructor requirements)
        function displayEngagementCharts(results) {
            var container = document.getElementById('engagementCharts');

            if (results.length === 0) {
                container.innerHTML = '<p class="no-data">No engagement data available</p>';
                return;
            }

            var uiAResults = results.filter(function(r) { return r.uiVersion === 'A'; });
            var uiBResults = results.filter(function(r) { return r.uiVersion === 'B'; });

            var html = '';

            // Calculate averages for Time to First Article Click
            function calcAvg(arr, field) {
                var validItems = arr.filter(function(r) { return r[field] !== undefined && r[field] !== null && !isNaN(r[field]); });
                if (validItems.length === 0) return 0;
                var sum = validItems.reduce(function(acc, r) { return acc + parseFloat(r[field]); }, 0);
                return Math.round(sum / validItems.length * 10) / 10;
            }

            var avgClickTimeA = calcAvg(uiAResults, 'timeToFirstArticleClickSec');
            var avgClickTimeB = calcAvg(uiBResults, 'timeToFirstArticleClickSec');
            var avgWillingnessA = calcAvg(uiAResults, 'willingnessToClick');
            var avgWillingnessB = calcAvg(uiBResults, 'willingnessToClick');

            // Time to First Article Click comparison
            html += `
                <div class="chart-card">
                    <h3 class="chart-title">Time to First Article Click</h3>
                    <div class="bar-chart" style="height: 180px; margin: 0;">
                        <div class="bar-wrapper">
                            <div class="bar ui-a" style="height: ${Math.min(avgClickTimeA * 10, 120)}px;"></div>
                            <span class="bar-label">UI-A</span>
                            <span>${avgClickTimeA}s</span>
                        </div>
                        <div class="bar-wrapper">
                            <div class="bar ui-b" style="height: ${Math.min(avgClickTimeB * 10, 120)}px;"></div>
                            <span class="bar-label">UI-B</span>
                            <span>${avgClickTimeB}s</span>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 13px; margin-top: 12px;">
                        Average time from feed load to first article click
                    </p>
                </div>
            `;

            // Willingness to Click comparison (bar chart style)
            html += `
                <div class="chart-card">
                    <h3 class="chart-title">Willingness to Click Articles</h3>
                    <div class="bar-chart" style="height: 180px; margin: 0;">
                        <div class="bar-wrapper">
                            <div class="bar ui-a" style="height: ${avgWillingnessA * 17}px;"></div>
                            <span class="bar-label">UI-A</span>
                            <span>${avgWillingnessA}/7</span>
                        </div>
                        <div class="bar-wrapper">
                            <div class="bar ui-b" style="height: ${avgWillingnessB * 17}px;"></div>
                            <span class="bar-label">UI-B</span>
                            <span>${avgWillingnessB}/7</span>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 13px; margin-top: 12px;">
                        "This interface encouraged me to click on articles" (1-7 scale)
                    </p>
                </div>
            `;

            // Focus Rating comparison
            var avgFocusA = calcAvg(uiAResults, 'perceivedFocus');
            var avgFocusB = calcAvg(uiBResults, 'perceivedFocus');

            html += `
                <div class="chart-card">
                    <h3 class="chart-title">Perceived Focus</h3>
                    <div class="bar-chart" style="height: 180px; margin: 0;">
                        <div class="bar-wrapper">
                            <div class="bar ui-a" style="height: ${avgFocusA * 17}px;"></div>
                            <span class="bar-label">UI-A</span>
                            <span>${avgFocusA}/7</span>
                        </div>
                        <div class="bar-wrapper">
                            <div class="bar ui-b" style="height: ${avgFocusB * 17}px;"></div>
                            <span class="bar-label">UI-B</span>
                            <span>${avgFocusB}/7</span>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 13px; margin-top: 12px;">
                        "How well were you able to focus while reading?" (1-7 scale)
                    </p>
                </div>
            `;

            // Readability Rating comparison
            var avgReadA = calcAvg(uiAResults, 'perceivedReadability');
            var avgReadB = calcAvg(uiBResults, 'perceivedReadability');

            html += `
                <div class="chart-card">
                    <h3 class="chart-title">Perceived Readability</h3>
                    <div class="bar-chart" style="height: 180px; margin: 0;">
                        <div class="bar-wrapper">
                            <div class="bar ui-a" style="height: ${avgReadA * 17}px;"></div>
                            <span class="bar-label">UI-A</span>
                            <span>${avgReadA}/7</span>
                        </div>
                        <div class="bar-wrapper">
                            <div class="bar ui-b" style="height: ${avgReadB * 17}px;"></div>
                            <span class="bar-label">UI-B</span>
                            <span>${avgReadB}/7</span>
                        </div>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 13px; margin-top: 12px;">
                        "How easy was it to read the text?" (1-7 scale)
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        function calculateStats(results) {
            var uiA = results.filter(function(r) { return r.uiVersion === 'A'; });
            var uiB = results.filter(function(r) { return r.uiVersion === 'B'; });

            function avg(arr, key) {
                if (arr.length === 0) return 0;
                var sum = arr.reduce(function(acc, item) {
                    return acc + (item[key] || 0);
                }, 0);
                return Math.round(sum / arr.length);
            }

            return {
                uiA: {
                    count: uiA.length,
                    avgTimeSec: avg(uiA, 'readingTimeSec'),
                    avgScroll: avg(uiA, 'maxScrollDepth')
                },
                uiB: {
                    count: uiB.length,
                    avgTimeSec: avg(uiB, 'readingTimeSec'),
                    avgScroll: avg(uiB, 'maxScrollDepth')
                }
            };
        }

        function showNoData() {
            document.getElementById('comparisonSection').innerHTML = `
                <div class="no-data" style="grid-column: span 2;">
                    <h3>No data yet</h3>
                    <p>Return to the home page and select a UI to test.</p>
                </div>
            `;

            document.getElementById('demographicsCharts').innerHTML = `
                <p class="no-data" style="grid-column: span 4;">No demographic data available yet.</p>
            `;

            document.getElementById('dataTableContainer').innerHTML = `
                <p class="no-data">No saved test results found.</p>
            `;
        }

        function displayComparison(stats) {
            var html = '';

            // UI-A card
            html += `
                <div class="result-card ui-a">
                    <h3>UI-A (Classic Design)</h3>
                    <div class="stat-box">
                        <div class="stat-value">${stats.uiA.count}</div>
                        <div class="stat-label">Test Count</div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Reading Time</span>
                        <span class="metric-value">${formatTime(stats.uiA.avgTimeSec)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Scroll Depth</span>
                        <span class="metric-value">${stats.uiA.avgScroll}%</span>
                    </div>
                </div>
            `;

            // UI-B card
            var betterTime = stats.uiB.avgTimeSec > stats.uiA.avgTimeSec;
            html += `
                <div class="result-card">
                    <h3>UI-B (Focus Frame)</h3>
                    <div class="stat-box ${betterTime ? 'winner' : ''}">
                        <div class="stat-value">${stats.uiB.count}</div>
                        <div class="stat-label">Test Count</div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Reading Time</span>
                        <span class="metric-value">${formatTime(stats.uiB.avgTimeSec)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Scroll Depth</span>
                        <span class="metric-value">${stats.uiB.avgScroll}%</span>
                    </div>
                </div>
            `;

            document.getElementById('comparisonSection').innerHTML = html;
        }

        function displayChart(stats) {
            var maxTime = Math.max(stats.uiA.avgTimeSec, stats.uiB.avgTimeSec, 1);
            var maxHeight = 150; // max bar height in px

            var heightA = (stats.uiA.avgTimeSec / maxTime) * maxHeight;
            var heightB = (stats.uiB.avgTimeSec / maxTime) * maxHeight;

            // animate bars after short delay
            setTimeout(function() {
                document.getElementById('barA').style.height = heightA + 'px';
                document.getElementById('barB').style.height = heightB + 'px';
            }, 100);

            document.getElementById('timeA').textContent = formatTime(stats.uiA.avgTimeSec);
            document.getElementById('timeB').textContent = formatTime(stats.uiB.avgTimeSec);
        }

        function displayTable(results) {
            if (results.length === 0) {
                document.getElementById('dataTableContainer').innerHTML = '<p>No data</p>';
                return;
            }

            var html = '<div style="overflow-x: auto;"><table class="data-table">';

            // header
            html += '<tr>';
            html += '<th>Participant</th>';
            html += '<th>Gender</th>';
            html += '<th>Age</th>';
            html += '<th>UI</th>';
            html += '<th>Article</th>';
            html += '<th>Time</th>';
            html += '<th>Scroll</th>';
            html += '<th>Score</th>';
            html += '<th>Focus</th>';
            html += '<th>Action</th>';
            html += '</tr>';

            // rows
            results.forEach(function(r, index) {
                var time = r.readingTimeSec || 0;
                var scroll = r.maxScrollDepth || 0;
                var pid = r.participantId || '-';
                var gender = r.gender || '-';
                var age = r.ageGroup || '-';
                var ui = r.uiVersion || '?';
                var article = r.articleId || r.articleTopic || '-';
                var score = r.comprehensionScore !== undefined ? (r.comprehensionScore === 1 ? '✓' : '✗') : '-';
                var focus = r.perceivedFocus || '-';
                var firebaseKey = r._firebaseKey || '';

                // format gender
                var genderDisplay = {
                    'male': 'M',
                    'female': 'F',
                    'other': 'O',
                    'prefer-not-to-say': '-'
                };
                gender = genderDisplay[gender] || gender;

                html += '<tr>';
                html += '<td>' + pid.substring(0, 8) + '</td>';
                html += '<td>' + gender + '</td>';
                html += '<td>' + age + '</td>';
                html += '<td>' + ui + '</td>';
                html += '<td>' + article + '</td>';
                html += '<td>' + formatTime(time) + '</td>';
                html += '<td>' + scroll + '%</td>';
                html += '<td style="color:' + (r.comprehensionScore === 1 ? '#28a745' : '#dc3545') + '">' + score + '</td>';
                html += '<td>' + focus + '/7</td>';
                html += '<td><button class="delete-btn" onclick="deleteResult(\'' + firebaseKey + '\', ' + index + ')">Delete</button></td>';
                html += '</tr>';
            });

            html += '</table></div>';

            document.getElementById('dataTableContainer').innerHTML = html;
        }

        // delete a single result
        function deleteResult(firebaseKey, index) {
            var item = allResults[index];
            var confirmMsg = 'Are you sure you want to delete this record?\n\nParticipant: ' + (item.participantId || '-') + '\nUI: ' + (item.uiVersion || '?');

            if (!confirm(confirmMsg)) {
                return;
            }

            // delete from Firebase
            if (firebaseKey && firebaseReady && database) {
                database.ref('results/' + firebaseKey).remove()
                    .then(function() {
                        console.log('Deleted from Firebase:', firebaseKey);
                        // reload data
                        loadResults();
                    })
                    .catch(function(err) {
                        console.error('Firebase delete failed:', err);
                        alert('Delete failed: ' + err.message);
                    });
            } else {
                // fallback: remove from local array and localStorage
                allResults.splice(index, 1);
                localStorage.setItem('hci_study_results', JSON.stringify(allResults));
                displayAllData();
            }
        }

        function formatTime(secs) {
            if (!secs) return '00:00';
            var m = Math.floor(secs / 60);
            var s = secs % 60;
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function handleClear() {
            if (confirm('Are you sure you want to delete all data?')) {
                clearResults();
                loadResults();
                alert('Data cleared.');
            }
        }

        // override export functions to use Firebase data
        function exportResultsAsJSON() {
            if (allResults.length === 0) {
                alert('No data to export');
                return;
            }

            var exportData = {
                results: allResults,
                exportedAt: new Date().toISOString(),
                summary: calculateStats(allResults)
            };

            var jsonStr = JSON.stringify(exportData, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            var link = document.createElement('a');
            link.href = url;
            link.download = 'hci_study_data_' + Date.now() + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportResultsAsCSV() {
            if (allResults.length === 0) {
                alert('No data to export');
                return;
            }

            var headers = ['participantId', 'gender', 'ageGroup', 'department', 'occupation', 'uiVersion', 'articleId', 'articleTopic', 'readingTimeSec', 'maxScrollDepth', 'distractionClicks', 'focusModeUsed', 'focusModeTimeSec', 'timeToFirstArticleClickSec', 'articleReadOrder', 'comprehensionScore', 'perceivedFocus', 'perceivedReadability', 'willingnessToClick', 'completedAt'];
            var csvLines = [];
            csvLines.push(headers.join(','));

            allResults.forEach(function(r) {
                var row = headers.map(function(h) {
                    var val = r[h];
                    if (val === null || val === undefined) return '';
                    var str = String(val);
                    if (str.indexOf(',') >= 0 || str.indexOf('"') >= 0) {
                        str = '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                });
                csvLines.push(row.join(','));
            });

            var csvContent = csvLines.join('\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);

            var link = document.createElement('a');
            link.href = url;
            link.download = 'hci_study_results_' + Date.now() + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
